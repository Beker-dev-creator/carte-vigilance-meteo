<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte de Vigilance M√©t√©o - France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 700px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .controls {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* Masquer le fond de carte en dehors de la France */
        .leaflet-tile-pane { 
            filter: hue-rotate(180deg) brightness(1.5) grayscale(100%) opacity(0.3); 
        }
    </style>
</head>
<body>
    <h1>Carte de Vigilance M√©t√©orologique - France</h1>
    <div id="map"></div>

    <script>
        // Configuration des limites de la carte (France m√©tropolitaine)
        const franceBounds = [[41, -5], [51, 10]];
        const map = L.map('map', {
            maxBounds: franceBounds,
            maxBoundsViscosity: 1.0,
            minZoom: 5,
            maxZoom: 12
        }).setView([46.5, 2], 6);

        // Fond de carte simplifi√©
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            bounds: franceBounds,
            noWrap: true
        }).addTo(map);

        // Emp√™cher le d√©placement hors de la France
        map.setMaxBounds(franceBounds);
        map.options.worldCopyJump = false;

        // Configuration des couleurs et pictogrammes
        const vigilanceColors = {
            'Vert': '#4CAF50',
            'Jaune': '#FFEB3B',
            'Orange': '#FF9800',
            'Rouge': '#F44336'
        };

        const pictograms = {
            'Soleil': '‚òÄÔ∏è',
            'Pluie': 'üåßÔ∏è',
            'Orage': '‚õàÔ∏è',
            'Neige': '‚ùÑÔ∏è',
            'Vent': 'üå¨Ô∏è',
            'Brouillard': 'üå´Ô∏è'
        };

        // Structure de donn√©es pour les d√©partements
        let departementsData = {};

        // Chargement du GeoJSON des d√©partements fran√ßais
        fetch('https://france-geojson.gregoiredavid.fr/repo/departements-version-simplifiee.geojson')
            .then(response => response.json())
            .then(data => {
                const departmentsLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            fillColor: vigilanceColors[departementsData[feature.properties.code]?.vigilance || 'Vert'],
                            weight: 1,
                            color: 'white',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const code = feature.properties.code;
                        
                        if (!departementsData[code]) {
                            departementsData[code] = {
                                name: feature.properties.nom,
                                vigilance: 'Vert',
                                picto: 'Soleil'
                            };
                        }

                        layer.bindPopup(`
                            <b>${departementsData[code].name}</b><br>
                            Vigilance: ${departementsData[code].vigilance}<br>
                            Ph√©nom√®ne: ${pictograms[departementsData[code].picto]} ${departementsData[code].picto}
                        `);

                        layer.on('click', function(e) {
                            selectedDept = code;
                            updateControls();
                            highlightFeature(e.target);
                        });
                    }
                }).addTo(map);

                // Ajustement automatique de la vue pour la France
                map.fitBounds(departmentsLayer.getBounds());
                addControls();
                addLegend();
            });

        // Fonction pour mettre en surbrillance un d√©partement
        function highlightFeature(layer) {
            layer.setStyle({
                weight: 3,
                color: '#000',
                fillOpacity: 0.7
            });
        }

        // Ajout des contr√¥les interactifs
        function addControls() {
            const controls = L.control({position: 'topright'});
            
            controls.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'controls');
                div.innerHTML = `
                    <h3>Contr√¥les</h3>
                    <select id="vigilance-select">
                        ${Object.keys(vigilanceColors).map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                    <div id="picto-selector">
                        ${Object.entries(pictograms).map(([name, picto]) => `
                            <button class="picto-btn" data-picto="${name}">${picto}</button>
                        `).join('')}
                    </div>
                `;
                return div;
            };
            
            controls.addTo(map);

            document.getElementById('vigilance-select').addEventListener('change', updateDepartment);
            document.querySelectorAll('.picto-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    departementsData[selectedDept].picto = this.dataset.picto;
                    updateDepartment();
                });
            });
        }

        // Ajout de la l√©gende
        function addLegend() {
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>L√©gende</h4>
                    ${Object.entries(vigilanceColors).map(([level, color]) => `
                        <div><span style="background:${color}">&nbsp;&nbsp;&nbsp;</span> ${level}</div>
                    `).join('')}
                    <h4>Pictogrammes</h4>
                    ${Object.entries(pictograms).map(([name, picto]) => `
                        <div>${picto} ${name}</div>
                    `).join('')}
                `;
                return div;
            };
            
            legend.addTo(map);
        }

        // Mise √† jour des contr√¥les
        let selectedDept = null;
        
        function updateControls() {
            if (selectedDept) {
                document.getElementById('vigilance-select').value = departementsData[selectedDept].vigilance;
            }
        }

        // Mise √† jour d'un d√©partement
        function updateDepartment() {
            if (selectedDept) {
                departementsData[selectedDept].vigilance = document.getElementById('vigilance-select').value;
                map.eachLayer(layer => {
                    if (layer.feature?.properties.code === selectedDept) {
                        layer.setStyle({
                            fillColor: vigilanceColors[departementsData[selectedDept].vigilance]
                        });
                        layer.bindPopup(`
                            <b>${departementsData[selectedDept].name}</b><br>
                            Vigilance: ${departementsData[selectedDept].vigilance}<br>
                            Ph√©nom√®ne: ${pictograms[departementsData[selectedDept].picto]} ${departementsData[selectedDept].picto}
                        `);
                    }
                });
            }
        }
    </script>
</body>
</html>
