<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Vigilance M√©t√©o France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 700px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .controls {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* Correction de l'interactivit√© */
        .leaflet-interactive {
            cursor: pointer !important;
        }
    </style>
</head>
<body>
    <h1>Carte de Vigilance M√©t√©orologique</h1>
    <div id="map"></div>

    <script>
        // Configuration de la carte
        const map = L.map('map', {
            minZoom: 5,
            maxZoom: 12,
            maxBounds: [[41, -5], [51, 10]]
        }).setView([46.5, 2], 6);

        // Fond de carte simplifi√©
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            noWrap: true
        }).addTo(map);

        // Couches interactives
        let departmentsLayer;
        let selectedDept = null;

        // Couleurs et pictogrammes
        const vigilanceColors = {
            'Vert': '#4CAF50',
            'Jaune': '#FFEB3B',
            'Orange': '#FF9800',
            'Rouge': '#F44336'
        };

        const pictograms = {
            'Soleil': '‚òÄÔ∏è',
            'Pluie': 'üåßÔ∏è',
            'Orage': '‚õàÔ∏è',
            'Neige': '‚ùÑÔ∏è',
            'Vent': 'üå¨Ô∏è',
            'Brouillard': 'üå´Ô∏è'
        };

        // Chargement des d√©partements
        fetch('https://france-geojson.gregoiredavid.fr/repo/departements-version-simplifiee.geojson')
            .then(res => res.json())
            .then(data => {
                departmentsLayer = L.geoJSON(data, {
                    style: feature => ({
                        fillColor: vigilanceColors['Vert'],
                        weight: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    }),
                    onEachFeature: (feature, layer) => {
                        const code = feature.properties.code;
                        
                        // Gestion des clics
                        layer.on({
                            click: e => {
                                selectedDept = code;
                                updateControls();
                                e.target.setStyle({ color: '#000', weight: 3 });
                                updatePopupContent(layer, code);
                            },
                            mouseout: e => {
                                if (code !== selectedDept) {
                                    e.target.setStyle({ color: 'white', weight: 1 });
                                }
                            }
                        });

                        // Initialisation du popup
                        updatePopupContent(layer, code);
                    }
                }).addTo(map);

                // Ajustement de la vue
                map.fitBounds(departmentsLayer.getBounds());
                addControls();
                addLegend();
            });

        function updatePopupContent(layer, code) {
            const baseContent = `
                <b>${layer.feature.properties.nom}</b><br>
                Vigilance: <span id="vigilance-${code}">Vert</span><br>
                Ph√©nom√®ne: <span id="picto-${code}">‚òÄÔ∏è Soleil</span>
            `;
            layer.bindPopup(baseContent);
        }

        function addControls() {
            const controls = L.control({position: 'topright'});
            
            controls.onAdd = () => {
                const div = L.DomUtil.create('div', 'controls');
                div.innerHTML = `
                    <h3>Modification</h3>
                    <select id="vigilance-select">
                        ${Object.entries(vigilanceColors).map(([n]) => `<option>${n}</option>`)}
                    </select>
                    <div class="picto-grid">
                        ${Object.entries(pictograms).map(([n, p]) => `
                            <button data-picto="${n}" class="picto-btn">${p}</button>
                        `).join('')}
                    </div>
                `;

                // Gestion des √©v√©nements
                div.querySelector('#vigilance-select').addEventListener('change', function() {
                    if (selectedDept) {
                        departmentsLayer.resetStyle();
                        departmentsLayer.eachLayer(layer => {
                            if (layer.feature.properties.code === selectedDept) {
                                layer.setStyle({ fillColor: vigilanceColors[this.value] });
                                document.querySelector(`#vigilance-${selectedDept}`).textContent = this.value;
                            }
                        });
                    }
                });

                div.querySelectorAll('.picto-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (selectedDept) {
                            document.querySelector(`#picto-${selectedDept}`).innerHTML = 
                                `${this.innerHTML} ${this.dataset.picto}`;
                        }
                    });
                });

                return div;
            };
            
            controls.addTo(map);
        }

        function addLegend() {
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>L√©gende</h4>
                    ${Object.entries(vigilanceColors).map(([n, c]) => `
                        <div><span style="background:${c}">&nbsp;&nbsp;&nbsp;</span> ${n}</div>
                    `).join('')}
                    <h4>Ph√©nom√®nes</h4>
                    ${Object.entries(pictograms).map(([n, p]) => `
                        <div>${p} ${n}</div>
                    `).join('')}
                `;
                return div;
            };
            
            legend.addTo(map);
        }

        function updateControls() {
            if (selectedDept) {
                document.getElementById('vigilance-select').value = 
                    document.querySelector(`#vigilance-${selectedDept}`).textContent;
            }
        }
    </script>
</body>
</html>
