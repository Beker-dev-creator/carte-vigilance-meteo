<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte Vigilance France</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 700px; }
        .legend, .controls { background: white; padding: 10px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Carte de Vigilance</h1>
    <div id="map"></div>

    <script>
        // Initialisation carte
        const map = L.map('map').setView([46.5, 2], 6);
        
        // Couche OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Donn√©es de vigilance
        const couleurs = {
            Vert: '#4CAF50',
            Jaune: '#FFEB3B',
            Orange: '#FF9800',
            Rouge: '#F44336'
        };

        // Chargement d√©partements
        fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-avec-outre-mer.geojson')
            .then(res => res.json())
            .then(data => {
                const couche = L.geoJSON(data, {
                    style: { color: 'white', weight: 1, fillOpacity: 0.7 },
                    onEachFeature: (feature, layer) => {
                        const code = feature.properties.code;
                        
                        // Initialisation alerte
                        layer.alerte = {
                            niveau: 'Vert',
                            picto: '‚òÄÔ∏è',
                            nom: feature.properties.nom
                        };

                        // Interaction au clic
                        layer.on('click', e => {
                            e.target.setStyle({ color: 'black', weight: 3 });
                            selected = code;
                            majControles();
                        });

                        // Popup dynamique
                        layer.bindPopup(`
                            <b>${layer.alerte.nom}</b><br>
                            Vigilance: <span class="niveau">${layer.alerte.niveau}</span><br>
                            Ph√©nom√®ne: <span class="picto">${layer.alerte.picto}</span>
                        `);
                    }
                }).addTo(map);

                // Centrer sur la France
                map.fitBounds(couche.getBounds());

                // Ajout contr√¥les
                const controles = L.control({position: 'topright'});
                controles.onAdd = () => {
                    const div = L.DomUtil.create('div', 'controls');
                    div.innerHTML = `
                        <h3>Modifier d√©partement</h3>
                        <select id="niveau">
                            ${Object.keys(couleurs).map(n => `<option>${n}</option>`)}
                        </select>
                        <div id="pictos">
                            ${['‚òÄÔ∏è','üåßÔ∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è'].map(p => `
                                <button class="picto" data-picto="${p}">${p}</button>
                            `).join('')}
                        </div>
                    `;
                    
                    // √âv√©nements
                    div.querySelector('#niveau').addEventListener('change', function() {
                        if(selected) majAlerte('niveau', this.value);
                    });
                    
                    div.querySelectorAll('.picto').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if(selected) majAlerte('picto', this.dataset.picto);
                        });
                    });
                    
                    return div;
                };
                controles.addTo(map);
            });

        let selected = null;

        function majAlerte(type, valeur) {
            map.eachLayer(layer => {
                if(layer.feature?.properties.code === selected) {
                    if(type === 'niveau') {
                        layer.setStyle({ fillColor: couleurs[valeur] });
                        layer.alerte.niveau = valeur;
                    } else {
                        layer.alerte.picto = valeur;
                    }
                    layer.getPopup().setContent(`
                        <b>${layer.alerte.nom}</b><br>
                        Vigilance: <span class="niveau">${layer.alerte.niveau}</span><br>
                        Ph√©nom√®ne: <span class="picto">${layer.alerte.picto}</span>
                    `);
                }
            });
        }

        function majControles() {
            if(selected) {
                map.eachLayer(layer => {
                    if(layer.feature?.properties.code === selected) {
                        document.getElementById('niveau').value = layer.alerte.niveau;
                    }
                });
            }
        }
    </script>
</body>
</html>
